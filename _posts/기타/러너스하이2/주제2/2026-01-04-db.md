---
layout: post
title: "DB"
date: 2026-01-04
categories: [기타, 러너스하이2, 주제2]
tags: [러너스하이2_주제2]
---

## DB Connection 상태

DB Connection 상태는 애플리케이션이 DB에 접근할 여유가 있는지, 혹은 요청이 대기 중인지 보여주는 지표다. CPU나 GC 지표보다 먼저 지연과 타임아웃의 원인을 드러내는 경우가 많다. 이 패널은 현재 느린 원인이 DB 성능 문제인지, 커넥션 풀 문제인지 판단하는 기준이 된다.

각 항목의 의미는 다음과 같다.

* **Active Connections**: 현재 DB와 연결되어 쿼리 실행 중이거나 트랜잭션을 점유하고 있는 커넥션 수다. 이 값이 높게 유지되면 DB 작업 시간이 길어지고 있음을 의미한다.
* **Idle Connections**: 풀에 존재하지만 사용되지 않는 유휴 커넥션 수다. 즉시 할당 가능한 여유 자원이다.
* **Pending Connections**: DB 커넥션을 얻기 위해 대기 중인 요청 수다. 이 값이 0이 아니라면 이미 풀의 최대 커넥션 수에 도달하여 병목이 발생했음을 뜻한다.
* **Max Connections**: 커넥션 풀에 설정된 최대 허용 수(Active + Idle)다.

패턴은 다음과 같이 해석한다.

* **Active가 Max 근접 + Pending 발생**: 커넥션 풀이 포화 상태다. 애플리케이션이 DB 커넥션을 얻지 못해 대기 중이며, HTTP Latency 급상승과 타임아웃, 5xx 오류로 이어진다.
* **Active 지속 증가 + Idle 부족**: 쿼리 처리 시간이 길어지거나 트랜잭션이 오래 유지되는 상태다. 인덱스 누락이나 슬로우 쿼리를 의심해야 한다.
* **Pending 증가 + CPU 낮음**: 애플리케이션 부하는 낮으나 DB 연결 문제로 막혀 있는 상태다. 스케일아웃으로 해결되지 않는 DB 쿼리나 트랜잭션 구조의 문제일 가능성이 높다.
* **Idle 충분 + Pending 없음**: 커넥션 자원에 여유가 있다. 현재 병목의 원인은 DB 커넥션이 아니다.

Pending이 증가하면서 HTTP P95/P99가 상승하면 커넥션 대기로 인한 지연이고, Active 증가와 함께 DB Query Latency가 상승하면 쿼리 성능 자체가 문제다.

![DB Connection Graph](/assets/imgs/posts/기타/러너스하이/주제2/db/image1.png)

## DB Connection Acquire Time

쿼리 실행 이전 단계에서 커넥션 풀로부터 커넥션을 획득하기까지의 실제 대기 시간을 나타낸다. 느린 응답의 원인이 DB 쿼리 실행 때문인지, 커넥션 풀 대기 때문인지 구분하는 지표다. 측정 대상은 전체 HTTP 요청이 아닌 DB 커넥션을 획득하려는 요청들이다.

* **Acquire Time (avg)**: 최근 5분간의 평균 대기 시간이다. 전체적인 추세를 보여준다.
* **Acquire Time p95**: 대다수(95%) 요청이 겪는 커넥션 획득 대기 시간이다. 운영 판단의 핵심 기준이 된다.
* **Acquire Time p99**: 상위 1% 요청이 겪은 최악의 대기 시간이다. 장애 전조를 가장 먼저 보여주며 타임아웃 발생 직전의 신호다.

해석 패턴은 다음과 같다.

* **p95 / p99 상승**: 커넥션 풀 회수가 느려지거나 트랜잭션 점유 시간이 길어지고 있다. 체감 지연이 이미 발생한 상태다.
* **p95 / p99 상승 + Pending 발생**: 커넥션 풀이 완전히 포화되어 구조적 병목이 발생했다. 쿼리 최적화 이전에 풀 크기나 트랜잭션 구조 점검이 필요하다.
* **Acquire Time 정상 + Query Latency 상승**: 커넥션 획득에는 문제가 없으며, DB 쿼리 성능이나 인덱스 문제다.

Acquire p95/p99가 오르면서 Pending이 함께 증가하면 커넥션 풀 병목이 확실하다. 반면 Acquire Time은 정상인데 HTTP P95/P99만 높다면 DB 외부나 애플리케이션 로직의 병목이다.

![DB Acquire Time Graph](/assets/imgs/posts/기타/러너스하이/주제2/db/image2.png)

## DB Connection Timeout Rate

애플리케이션이 DB 커넥션을 얻지 못해 `connectionTimeout` 내에 실패한 빈도를 보여준다. SQL 실행 이전 단계에서 발생하는 문제로, DB, 네트워크, 락 문제를 가장 빠르게 감지할 수 있는 지표다. HTTP 요청 성공 여부와 무관하게 DB 풀 레벨에서 발생한 실제 실패 이벤트를 나타낸다.

값은 최근 5분간의 초당 평균 실패 횟수(ops/s)를 의미한다. 예를 들어 0.02 ops/s는 5분 동안 약 6회의 커넥션 획득 실패가 있었음을 뜻한다. 원인으로는 DB 과부하, 네트워크 불안정, 트랜잭션/락으로 인한 반환 지연, 풀 사이즈 부족 등이 있다.

패턴은 다음과 같이 해석한다.

* **Timeout Rate 상승**: DB 접근 자체가 차단되기 시작했다. 애플리케이션의 재시도 로직과 무관하게 장애 신호이며 HTTP 5xx 오류로 전파될 가능성이 높다.
* **Timeout Rate 0**: DB 커넥션 획득 단계는 정상이다. 병목이 있다면 SQL 실행이나 애플리케이션 로직 문제다.
* **Timeout Rate 순간 스파이크**: 배치 작업, 락 경쟁, 순간적인 트래픽 집중 등으로 인한 일시적 DB 부하 급증이다.
* **Timeout Rate 지속 증가**: 풀 사이즈 부족이나 트랜잭션 설계 문제 등 구조적 결함을 시사한다.

Timeout Rate가 상승하면서 HTTP 5xx가 함께 증가하면 DB 장애가 사용자에게 전파된 것이고, 5xx가 없다면 내부 재시도나 큐잉으로 방어하고 있는 잠재적 장애 상태다. Timeout Rate가 증가하는데 Acquire p99도 높다면 커넥션 풀 고갈이나 락 경쟁일 가능성이 크다.

![DB Timeout Graph](/assets/imgs/posts/기타/러너스하이/주제2/db/image3.png)
