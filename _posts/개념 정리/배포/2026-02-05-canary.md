---
layout: post
title: "카나리 배포"
date: 2026-02-05
categories: [개념정리, 배포]
tags: [canary, devops]
---

## 1. 카나리 배포 개요

![Canary Deployment](/assets/imgs/posts/개념정리/배포/canary_deployment.gif)

카나리 배포(Canary Deployment)는 새 버전을 전체 사용자에게 한 번에 노출하지 않고, 일부 트래픽에만 먼저 적용한 뒤 점진적으로 비율을 늘려가는 배포 전략이다.

이름은 과거 광산에서 유독가스를 감지하기 위해 먼저 들여보내던 카나리아에서 유래했다. 소수의 사용자에게 먼저 노출해 문제가 있는지 확인하는 방식이다.

## 2. 블루그린 배포와의 차이

블루그린과의 핵심 차이는 트래픽 전환 방식이다.

- 블루그린: 0% → 100% 한 번에 전환
- 카나리: 1% → 5% → 25% → 50% → 100% 점진 전환

카나리는 단순한 배포가 아니라 실시간 검증을 포함한 운영 전략에 가깝다.

## 3. 동작 흐름

1. 기존 버전이 전체 트래픽 처리
2. 새 버전을 소수의 인스턴스로 배포
3. 전체 트래픽 중 일부만 새 버전으로 라우팅
4. 지표 관찰 (에러율, 지연 시간, 리소스 사용량)
5. 문제 없으면 트래픽 비율 증가
6. 이상 발생 시 즉시 중단 또는 축소

이 과정에서 두 버전이 동시에 운영된다.

## 4. 카나리 배포의 특징

### 실제 트래픽 기반 검증

테스트 환경에서는 발견되지 않는 문제들이 있다.

- 특정 사용자 데이터 패턴
- 실시간 트래픽 폭주
- 캐시 미스 / 쿼리 폭증
- 외부 API 호출 실패

카나리는 이런 문제를 실제 환경에서, 제한된 범위로 드러나게 한다.

### 대규모 트래픽 서비스에 적합

트래픽이 큰 서비스에서는 100% 전환 자체가 리스크다. 카나리는 전체 장애로 확산되기 전에 작은 신호로 위험을 감지할 수 있다.

### 지표 기반 의사결정

카나리 배포는 모니터링과 함께 사용된다. 일반적으로 다음 기준으로 판단한다.

- HTTP 5xx 비율
- p95 / p99 응답 시간
- CPU / Memory 사용률
- 특정 비즈니스 지표 (결제 성공률 등)

감이 아니라 수치로 배포 여부를 결정한다.

## 5. 전제 조건

카나리는 아무 서비스에나 적용하기 어렵다. 다음 조건이 필요하다.

### 무상태(stateless) 애플리케이션

- 세션이 인스턴스에 묶여 있으면 안 됨
- Sticky session은 카나리와 궁합이 나쁨

### 모니터링 체계

- 에러율
- 지연 시간
- 리소스 지표
- 로그 추적

이 중 하나라도 없으면 카나리는 위험해진다.

### 트래픽 제어 지점

카나리는 트래픽을 비율로 나눌 수 있는 지점이 필요하다.

- Ingress / Gateway
- Service Mesh
- L7 Load Balancer

애플리케이션 내부 로직으로 처리하는 방식은 일반적이지 않다.

## 6. 데이터베이스 처리

카나리는 DB 변경과 궁합이 나쁘다. 두 버전이 동시에 DB를 사용하기 때문에 스키마 불일치 시 충돌이 발생한다.

카나리 배포에서의 DB 처리 원칙은 다음과 같다.

- DB 변경은 사전에 완료
- 하위 호환성 유지 필수
- 파괴적 변경은 별도 단계로 분리

이 원칙을 어기면 카나리는 오히려 장애를 키운다.

## 7. 카나리 배포의 한계

### 운영 복잡도 증가

- 두 버전 동시 운영
- 트래픽 비율 관리
- 지표 해석 필요

블루그린보다 운영 난이도가 높다.

### 장애 감지 지연

- 소수 트래픽에서만 발생하는 문제
- 지표 변화가 미미해 감지 어려움

정교한 기준 설정이 필요하다.

### 사용자 경험 불일치

- 같은 기능인데 사용자마다 결과가 다를 수 있음
- UI / UX 변경 시 민감한 부분
