---
layout: post
title: "블루그린 배포"
date: 2026-02-05
categories: [개념정리, 배포]
tags: [blue-green, devops]
---

## 블루그린 배포 개요

![Blue Green Deployment](/assets/imgs/posts/개념정리/배포/blue_green_deployment.gif)

블루그린 배포(Blue-Green Deployment)는 동일한 두 개의 운영 환경을 유지하면서 배포하는 전략이다. 하나는 현재 서비스 중인 환경(Blue), 다른 하나는 새 버전을 배포하기 위한 대기 환경(Green)이다.

동작 방식은 다음과 같다.

- 새 버전을 기존 운영 환경과 분리된 환경에 배포
- 검증이 끝나면 트래픽을 한 번에 전환
- 문제 발생 시 이전 환경으로 되돌림

배포 과정에서 사용자 트래픽은 중단되지 않는다.

## 블루그린 배포의 특징

**무중단 배포**

배포 중에도 항상 하나의 환경이 정상 동작한다. 배포 실패, 애플리케이션 재시작, 마이그레이션 과정이 사용자 요청에 직접 영향을 주지 않는다.

**낮은 롤백 비용**

문제가 발생했을 때 코드 롤백이나 재배포가 필요 없다. 트래픽을 다시 Blue 환경으로 되돌리면 된다.

**배포 리스크 격리**

새 버전은 실제 사용자 트래픽을 받기 전까지 격리된 상태로 검증된다.

## 동작 구조

**전체 흐름**

1. Blue 환경이 현재 모든 트래픽을 처리
2. Green 환경에 새 버전 배포
3. Green 환경에 대해 헬스체크, 통합 테스트, 스모크 테스트 수행
4. 로드밸런서 또는 서비스 설정을 변경하여 트래픽 전환
5. Green이 새로운 운영 환경이 됨
6. Blue는 대기 상태로 유지 (또는 제거)

배포 시점과 트래픽 전환 시점이 분리되어 있다는 점이 중요하다.

## 트래픽 전환 지점

블루그린 배포에서 트래픽 스위칭은 일반적으로 다음 중 하나에서 이루어진다.

- L4 / L7 로드밸런서
- DNS 레벨
- Kubernetes Service / Ingress
- API Gateway

이 지점에서 "어느 환경으로 요청을 보낼지"만 변경된다. 애플리케이션 내부 로직은 트래픽 전환을 인지하지 못한다.

## 데이터베이스 처리

블루그린 배포에서 DB 처리는 주의가 필요한 부분이다. 블루그린 배포와 DB 변경을 한 번에 수행하면 롤백이 불가능해지는 상황이 발생한다. DB 변경은 항상 여러 배포에 걸쳐 나눠서 진행해야 한다.

핵심 원칙은 DB가 항상 이전 버전과 신규 버전 애플리케이션이 동시에 동작 가능한 상태를 유지하는 것이다.

**일반적인 구성**

- 애플리케이션만 Blue/Green으로 분리
- 데이터베이스는 공용으로 사용
- 스키마 변경은 하위 호환성을 유지

**단계적 DB 변경 패턴**

DB 변경이 필요한 경우 다음 순서로 진행한다.

1단계로 하위 호환 가능한 변경만 수행한다. 컬럼 추가, 테이블 추가, 인덱스 추가, nullable 컬럼 추가 등이 해당된다. 이 단계에서는 기존 애플리케이션(Blue)에 영향이 없고, 새 애플리케이션(Green)도 사용 가능하다.

2단계로 Green에 새 컬럼이나 새 테이블을 사용하는 코드를 배포한다. 읽기는 기존 컬럼 fallback이 가능하도록 하고, 쓰기는 새 컬럼과 기존 컬럼에 동시에 수행하는 것도 고려한다. 이 단계에서 블루그린의 효과가 가장 크다. 문제가 생기면 즉시 Blue로 롤백할 수 있고, DB는 아직 안전한 상태다.

3단계로 모든 트래픽이 새 버전으로 안정화되면 그때 기존 컬럼 제거, 기존 테이블 제거, 타입 변경 같은 파괴적 변경을 수행한다. 이 단계는 블루그린과 무관하게 수행된다.

**컬럼 타입 변경**

컬럼 타입을 직접 변경하는 것은 이전 앱이 깨지고 롤백이 불가능해진다.

```sql
-- 직접 변경하면 안 된다
ALTER TABLE user ALTER COLUMN age TYPE BIGINT;
```

대신 다음 순서로 진행한다.

1. 새 컬럼 추가: `ALTER TABLE user ADD COLUMN age_v2 BIGINT;`
2. 양쪽 컬럼 동시 쓰기 (write: age + age_v2, read: age_v2 없으면 age)
3. 데이터 백필: `UPDATE user SET age_v2 = age;`
4. 트래픽 안정 후 기존 컬럼 제거

**테이블 구조 변경**

테이블 구조를 크게 바꾸는 경우 두 가지 전략이 있다.

**병행 운영**: 기존 테이블을 유지하면서 신규 테이블을 생성하고, 애플리케이션이 점진적으로 신규 테이블을 사용하도록 전환한다. 가장 안전하지만 구현 비용이 높다.

**마이그레이션 윈도우 분리**: 배포와 DB 이전을 완전히 분리한다. 트래픽이 적은 시간에 DB 이전을 수행하고, 그 다음 블루그린 배포를 진행한다.

**배포 전 체크리스트**

DB 변경이 포함된 배포 전에 확인해야 할 항목이다.

- 이전 버전 앱이 새 DB 스키마에서 동작하는가
- 신규 버전 앱이 이전 데이터도 읽을 수 있는가
- DB 변경이 롤백 불가능한지 여부
- 마이그레이션 스크립트가 idempotent한지

이 중 하나라도 NO면 DB 변경을 더 쪼개야 한다.

블루그린은 애플리케이션 배포 전략이지 DB 배포 전략이 아니다. DB는 대부분 되돌릴 수 없기 때문에 블루그린보다 DB가 항상 먼저 설계 대상이 된다.

## 블루그린 배포의 한계

**인프라 비용 증가**

운영 환경을 항상 두 세트 유지해야 하므로 리소스 비용이 증가한다.

**대규모 트래픽 서비스 부담**

트래픽을 한 번에 100% 전환하기 때문에, 사전에 충분한 부하 테스트가 없으면 위험할 수 있다.

**상태를 가지는 서비스**

세션을 메모리에 저장하거나 상태를 가지는 구조라면 트래픽 전환 시 사용자 경험 문제가 발생할 수 있다.
